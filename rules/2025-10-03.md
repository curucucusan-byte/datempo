# Regras — 2025-10-03

Este documento registra as regras de negócio vigentes a partir de 2025-10-03. Não edite documentos anteriores; ajuste sempre criando um novo arquivo datado.

## Planos e ciclo de vida da conta
- Conta nova inicia no plano `free` e status ativo (sem período de teste).
- O plano `free` é sempre considerado ativo para efeitos de uso do sistema (pode agendar nos limites do plano).
- Compra/upgrade de plano só é permitida após login. Usuários não autenticados são redirecionados para `/login` com mensagem de “login requerido”.
- Ao perder cobrança/recorrência ou cancelar a assinatura, a conta volta para `free` automaticamente e permanece ativa. Exibir aviso de downgrade e encaminhar para `/dashboard/plans` para novo upgrade.

## Agendamento público (link compartilhável)
- Cada agenda pode ter um token público (`publicToken`).
- Quando `publicToken` existir, o link público obrigatório é `/agenda/:slug/:h` (onde `:h` é o token). O caminho sem token não deve funcionar.
- APIs públicas exigem o token:
  - Disponibilidade: `GET /api/availability?slug=...&date=YYYY-MM-DD&h=...`
  - Criar agendamento: `POST /api/appointment` com `{ slug, h, ... }`.
- Se o token não for válido/ausente, retornar erro genérico: “Agenda não encontrada ou link inválido.”
- O dono pode regenerar o token pelo dashboard (invalida links anteriores).

## Logotipo da agenda
- Até segunda decisão, arquivos ficam no repositório em `public/agenda-logos/{slug}/`.
- O caminho do logo é salvo em `linkedCalendars[].logoPath` (ex.: `/agenda-logos/{slug}/logo.webp`).
- Exibição nas páginas públicas usa o `logoPath`; fallback para `/logos/calendar.png`.

## Regras de agendamento e UX
- Bloquear datas/horários passados com base no fuso do cliente; mensagem: “Escolha um horário no futuro.”
- Internamente, falhas de infraestrutura/billing do dono não devem aparecer ao cliente. Mensagem padrão: “Agenda indisponível no momento. Tente novamente mais tarde.”
- Formulário público:
  - Data mínima = hoje.
  - Seleção de horários em grid (slots livres), com estados de carregando/selecionado/indisponível.
  - WhatsApp deve ser válido em formato E.164 BR (`+55DDDNÚMERO`).

## Pagamentos e pré-pagamento por agenda
- Pré-pagamento manual (Pix/instruções) só disponível a partir do plano Starter.
- Pré-pagamento via cartão (Stripe) ainda não está habilitado no fluxo público; a API deve bloquear com erro amigável.

