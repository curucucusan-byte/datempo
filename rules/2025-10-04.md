# Regras — 2025-10-04

## Contagem e controle de mensagens WhatsApp
- A partir de agora todo agendamento deve disparar duas mensagens via API Meta:
  - Cliente: “Recebemos seu pedido. Aguarde confirmação.”
  - Dono da agenda: “Novo agendamento {cliente}/{data} adicionado ao Google. Confirme pelo Google ou respondendo aqui.”
- Lembretes automáticos também utilizam a API Meta (nada de link wa.me).
- Cada envio deve ser registrado em um histórico persistente com:
  - `messageId` retornado pela Meta,
  - `ownerUid` (conta dona da agenda),
  - `appointmentId` (quando houver),
  - `direction` (`to_customer` | `to_owner` | `reminder` etc.),
  - `body` da mensagem,
  - timestamp e status (ok/erro).
- A contagem mensal de mensagens por conta deve ser incrementada a cada envio bem-sucedido ou tentativa cobrável. Esse total precisa estar disponível no dashboard.
- Quando atingir o limite do plano, bloquear novos envios e enviar mensagem final informando o bloqueio.
- Precisamos prever endpoint/rotina que permita confirmar agendamento via WhatsApp ou Google e, após a confirmação, enviar mensagem de confirmação ao cliente.

## Próximos passos (alto nível)
1. Implementar camada de registro de mensagens (persistência + consulta no dashboard).
2. Ajustar fluxo de agendamento para usar apenas a API Meta e contabilizar as mensagens do cliente/dono.
3. Criar mecanismo de confirmação (por resposta WhatsApp ou evento Google) que gera mensagem de “agendamento confirmado”.
4. Exibir histórico e consumo no dashboard; travar envios quando chegar no limite e notificar.
